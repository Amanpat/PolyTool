<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PolyTool Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
/* ── Reset ───────────────────────────────────────────────── */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

/* ── Variables ───────────────────────────────────────────── */
:root{
  --bg:#f4f5f8;--surface:#fff;--border:#d6dbe6;
  --text:#1f2430;--muted:#5a6475;--accent:#1e5ec8;
  --nav-bg:#1b2030;--nav-text:#c5cad8;--nav-active:#fff;
  --pill-ok:#d4edda;--pill-ok-text:#155724;
  --pill-warn:#fff3cd;--pill-warn-text:#856404;
  --pill-err:#f8d7da;--pill-err-text:#721c24;
  --pill-run:#cce5ff;--pill-run-text:#004085;
  --radius:8px;
}

html,body{height:100%;font-family:"Segoe UI",Tahoma,Arial,sans-serif;color:var(--text);background:var(--bg)}

/* ── Layout ──────────────────────────────────────────────── */
#shell{display:flex;height:100vh}

/* ── Left nav ────────────────────────────────────────────── */
nav#sidebar{
  width:200px;min-width:200px;background:var(--nav-bg);
  color:var(--nav-text);display:flex;flex-direction:column;
  padding:16px 0;user-select:none;
}
nav#sidebar .logo{
  font-size:1.05rem;font-weight:700;color:#fff;
  padding:0 20px 18px;letter-spacing:.5px;
}
nav#sidebar .logo span{color:var(--accent)}
nav#sidebar button{
  display:flex;align-items:center;gap:10px;
  background:none;border:none;color:var(--nav-text);
  font-size:.92rem;padding:10px 20px;width:100%;
  text-align:left;cursor:pointer;transition:background .15s,color .15s;
}
nav#sidebar button:hover{background:rgba(255,255,255,.06)}
nav#sidebar button.active{color:var(--nav-active);background:rgba(255,255,255,.10);font-weight:600}
nav#sidebar button svg{width:18px;height:18px;flex-shrink:0;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

/* ── Main content ────────────────────────────────────────── */
#content{flex:1;overflow-y:auto;padding:28px 32px}
.page{display:none}
.page.visible{display:block}
h1.page-title{font-size:1.45rem;margin-bottom:18px}

/* ── Cards / stat boxes ─────────────────────────────────── */
.stat-row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:22px}
.stat-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:18px 22px;min-width:150px;flex:1;
}
.stat-card .label{font-size:.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.stat-card .value{font-size:1.6rem;font-weight:700;margin-top:4px}

/* ── Tables ──────────────────────────────────────────────── */
table.studio{
  width:100%;border-collapse:collapse;background:var(--surface);
  border:1px solid var(--border);border-radius:var(--radius);
  overflow:hidden;font-size:.88rem;
}
table.studio th,table.studio td{
  padding:10px 14px;text-align:left;border-bottom:1px solid #eaecf2;
  white-space:nowrap;
}
table.studio thead th{background:#f7f8fb;font-weight:600;color:var(--muted);font-size:.8rem;text-transform:uppercase;letter-spacing:.3px}
table.studio tbody tr:hover{background:#f0f3fa}
table.studio a{color:var(--accent);text-decoration:none}
table.studio a:hover{text-decoration:underline}

/* ── Pills ───────────────────────────────────────────────── */
.pill{
  display:inline-block;padding:2px 10px;border-radius:12px;
  font-size:.78rem;font-weight:600;
}
.pill-ok{background:var(--pill-ok);color:var(--pill-ok-text)}
.pill-warnings{background:var(--pill-warn);color:var(--pill-warn-text)}
.pill-error{background:var(--pill-err);color:var(--pill-err-text)}
.pill-running{background:var(--pill-run);color:var(--pill-run-text)}
.pill-shadow{background:#e0d4f5;color:#4a2a8a}
.pill-run{background:#d4e8f5;color:#1a4a6a}
.pill-sweep{background:#f5e6d4;color:#6a3e1a}

/* ── Buttons ─────────────────────────────────────────────── */
button.btn{
  padding:6px 14px;border:1px solid var(--border);border-radius:6px;
  background:var(--surface);color:var(--text);font-size:.82rem;
  cursor:pointer;transition:background .12s;
}
button.btn:hover{background:#eef1f7}
button.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
button.btn-primary:hover{background:#1650a8}
button.btn:disabled{opacity:.5;cursor:not-allowed}

/* ── Reports picker ──────────────────────────────────────── */
.report-controls{display:flex;gap:12px;align-items:center;margin-bottom:14px}
select.report-select{
  padding:7px 12px;border:1px solid var(--border);border-radius:6px;
  font-size:.88rem;min-width:360px;background:var(--surface);
}
iframe.report-frame{
  width:100%;height:calc(100vh - 180px);border:1px solid var(--border);
  border-radius:var(--radius);background:#fff;
}

/* ── Settings ────────────────────────────────────────────── */
.settings-section{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:18px 22px;margin-bottom:16px;
}
.settings-section h2{font-size:1rem;margin-bottom:8px}
.settings-section p{color:var(--muted);font-size:.88rem}

/* ── Empty state ─────────────────────────────────────────── */
.empty{color:var(--muted);font-style:italic;padding:18px 0}
  </style>
</head>
<body>
<div id="shell">

  <!-- ─── Left Navigation ─────────────────────────────── -->
  <nav id="sidebar">
    <div class="logo">Poly<span>Tool</span> Studio</div>

    <button data-tab="dashboard" class="active">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Dashboard
    </button>

    <button data-tab="sessions">
      <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Sessions
    </button>

    <button data-tab="tapes">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><line x1="12" y1="2" x2="12" y2="5"/><line x1="12" y1="19" x2="12" y2="22"/></svg>
      Tapes
    </button>

    <button data-tab="reports">
      <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      Reports
    </button>

    <button data-tab="settings">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      Settings
    </button>
  </nav>

  <!-- ─── Main Content ────────────────────────────────── -->
  <div id="content">

    <!-- Dashboard -->
    <div id="page-dashboard" class="page visible">
      <h1 class="page-title">Dashboard</h1>
      <div class="stat-row">
        <div class="stat-card"><div class="label">Runs</div><div class="value" id="dash-runs">-</div></div>
        <div class="stat-card"><div class="label">Shadow Runs</div><div class="value" id="dash-shadow">-</div></div>
        <div class="stat-card"><div class="label">Sweeps</div><div class="value" id="dash-sweeps">-</div></div>
        <div class="stat-card"><div class="label">Tapes</div><div class="value" id="dash-tapes">-</div></div>
      </div>
      <div id="dash-recent"></div>
    </div>

    <!-- Sessions -->
    <div id="page-sessions" class="page">
      <h1 class="page-title">Sessions</h1>
      <div style="margin-bottom:12px">
        <button class="btn" onclick="loadSessions()" title="Refresh">&#x21bb; Refresh</button>
      </div>
      <div id="sessions-body"></div>
    </div>

    <!-- Tapes -->
    <div id="page-tapes" class="page">
      <h1 class="page-title">Tapes</h1>
      <div style="margin-bottom:12px">
        <button class="btn" onclick="loadTapes()" title="Refresh">&#x21bb; Refresh</button>
      </div>
      <div id="tapes-body"></div>
    </div>

    <!-- Reports -->
    <div id="page-reports" class="page">
      <h1 class="page-title">Reports</h1>
      <div class="report-controls">
        <select class="report-select" id="report-picker">
          <option value="">Select a report&hellip;</option>
        </select>
        <button class="btn" onclick="loadReportList()" title="Refresh">&#x21bb;</button>
      </div>
      <iframe id="report-iframe" class="report-frame" src="about:blank"></iframe>
    </div>

    <!-- Settings -->
    <div id="page-settings" class="page">
      <h1 class="page-title">Settings</h1>
      <div class="settings-section">
        <h2>Artifacts Directory</h2>
        <p><code>artifacts/simtrader/</code></p>
      </div>
      <div class="settings-section">
        <h2>Studio Server</h2>
        <p>Running on <code id="settings-origin">-</code></p>
      </div>
      <div class="settings-section">
        <h2>About</h2>
        <p>PolyTool Studio v0.1 &mdash; SimTrader artifact browser and session manager.</p>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /shell -->

<script>
/* ================================================================
   PolyTool Studio — vanilla JS front-end
   ================================================================ */

// ── Tab navigation ──────────────────────────────────────────
document.querySelectorAll("nav#sidebar button[data-tab]").forEach(btn => {
  btn.addEventListener("click", () => switchTab(btn.dataset.tab));
});

function switchTab(tab) {
  document.querySelectorAll("nav#sidebar button").forEach(b => b.classList.remove("active"));
  document.querySelector(`nav#sidebar button[data-tab="${tab}"]`).classList.add("active");
  document.querySelectorAll(".page").forEach(p => p.classList.remove("visible"));
  document.getElementById("page-" + tab).classList.add("visible");

  // Lazy-load data on first visit
  if (tab === "dashboard") loadDashboard();
  if (tab === "sessions") loadSessions();
  if (tab === "tapes") loadTapes();
  if (tab === "reports") loadReportList();
  if (tab === "settings") document.getElementById("settings-origin").textContent = location.origin;
}

// ── Fetch helper ────────────────────────────────────────────
async function api(path) {
  const res = await fetch(path);
  if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  return res.json();
}

// ── Formatting helpers ──────────────────────────────────────
function fmtDate(iso) {
  if (!iso) return "-";
  try {
    const d = new Date(iso);
    return d.toLocaleString(undefined, { month:"short", day:"numeric", hour:"2-digit", minute:"2-digit", second:"2-digit" });
  } catch { return iso; }
}

function statusPill(status) {
  const cls = {
    ok: "pill-ok", warnings: "pill-warnings", error: "pill-error", running: "pill-running",
  }[status] || "pill-ok";
  return `<span class="pill ${cls}">${esc(status)}</span>`;
}

function categoryPill(cat) {
  const cls = { shadow: "pill-shadow", run: "pill-run", sweep: "pill-sweep" }[cat] || "";
  return `<span class="pill ${cls}">${esc(cat)}</span>`;
}

function esc(s) { const d = document.createElement("div"); d.textContent = s || ""; return d.innerHTML; }

// ── Dashboard ───────────────────────────────────────────────
let dashLoaded = false;
async function loadDashboard() {
  if (dashLoaded) return;
  try {
    const data = await api("/api/studio/dashboard");
    document.getElementById("dash-runs").textContent = data.runs ?? 0;
    document.getElementById("dash-shadow").textContent = data.shadow_runs ?? 0;
    document.getElementById("dash-sweeps").textContent = data.sweeps ?? 0;
    document.getElementById("dash-tapes").textContent = data.tapes ?? 0;
    dashLoaded = true;

    // Show a few recent sessions
    const sess = await api("/api/studio/sessions");
    const recent = (sess.sessions || []).slice(0, 5);
    if (recent.length) {
      document.getElementById("dash-recent").innerHTML =
        "<h2 style='font-size:1rem;margin-bottom:10px'>Recent Sessions</h2>" +
        buildSessionsTable(recent);
    }
  } catch (e) {
    console.error("dashboard", e);
  }
}

// ── Sessions ────────────────────────────────────────────────
async function loadSessions() {
  const el = document.getElementById("sessions-body");
  el.innerHTML = "<p class='empty'>Loading&hellip;</p>";
  try {
    const data = await api("/api/studio/sessions");
    if (!data.sessions || !data.sessions.length) {
      el.innerHTML = "<p class='empty'>No sessions found.</p>";
      return;
    }
    el.innerHTML = buildSessionsTable(data.sessions);
  } catch (e) {
    el.innerHTML = `<p class='empty'>Error: ${esc(e.message)}</p>`;
  }
}

function buildSessionsTable(sessions) {
  let html = `<table class="studio"><thead><tr>
    <th>Run ID</th><th>Type</th><th>Created</th><th>Market</th>
    <th>Status</th><th>Net Profit</th><th>Actions</th>
  </tr></thead><tbody>`;
  for (const s of sessions) {
    const reportLink = s.has_report
      ? `<a href="/artifacts/${s.category === 'shadow' ? 'shadow_runs' : s.category === 'sweep' ? 'sweeps' : 'runs'}/${esc(s.run_id)}/report.html" target="_blank">Report</a>`
      : "";
    const artifactLink = `<a href="/artifacts/${s.category === 'shadow' ? 'shadow_runs' : s.category === 'sweep' ? 'sweeps' : 'runs'}/${esc(s.run_id)}/run_manifest.json" target="_blank">Manifest</a>`;
    html += `<tr>
      <td><code>${esc(s.run_id)}</code></td>
      <td>${categoryPill(s.category)}</td>
      <td>${fmtDate(s.created_at)}</td>
      <td>${esc(s.market_slug) || "<span style='color:var(--muted)'>-</span>"}</td>
      <td>${statusPill(s.status)}</td>
      <td style="font-family:monospace">${esc(s.net_profit)}</td>
      <td>${reportLink} ${artifactLink}</td>
    </tr>`;
  }
  html += "</tbody></table>";
  return html;
}

// ── Tapes ───────────────────────────────────────────────────
async function loadTapes() {
  const el = document.getElementById("tapes-body");
  el.innerHTML = "<p class='empty'>Loading&hellip;</p>";
  try {
    const data = await api("/api/studio/tapes");
    if (!data.tapes || !data.tapes.length) {
      el.innerHTML = "<p class='empty'>No tapes found.</p>";
      return;
    }
    let html = `<table class="studio"><thead><tr>
      <th>Tape ID</th><th>Created</th><th>Market</th><th>Events</th><th>Actions</th>
    </tr></thead><tbody>`;
    for (const t of data.tapes) {
      html += `<tr>
        <td><code>${esc(t.tape_id)}</code></td>
        <td>${fmtDate(t.created_at)}</td>
        <td>${esc(t.market_slug) || "<span style='color:var(--muted)'>-</span>"}</td>
        <td>${t.event_count != null ? t.event_count : "-"}</td>
        <td>${t.has_events ? `<a href="/artifacts/tapes/${esc(t.tape_id)}/events.jsonl" target="_blank">events.jsonl</a>` : "-"}</td>
      </tr>`;
    }
    html += "</tbody></table>";
    el.innerHTML = html;
  } catch (e) {
    el.innerHTML = `<p class='empty'>Error: ${esc(e.message)}</p>`;
  }
}

// ── Reports ─────────────────────────────────────────────────
async function loadReportList() {
  const picker = document.getElementById("report-picker");
  try {
    const data = await api("/api/studio/reports");
    // Preserve current selection if possible
    const prev = picker.value;
    picker.innerHTML = '<option value="">Select a report&hellip;</option>';
    for (const r of (data.reports || [])) {
      const label = `${r.run_id}${r.market_slug ? " — " + r.market_slug : ""} (${r.category})`;
      const opt = document.createElement("option");
      opt.value = r.report_url;
      opt.textContent = label;
      picker.appendChild(opt);
    }
    if (prev) picker.value = prev;
  } catch (e) {
    console.error("reports", e);
  }
}

document.getElementById("report-picker").addEventListener("change", function () {
  const iframe = document.getElementById("report-iframe");
  iframe.src = this.value || "about:blank";
});

// ── Boot ────────────────────────────────────────────────────
loadDashboard();
</script>
</body>
</html>
