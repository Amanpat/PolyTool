<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SimTrader Studio</title>
  <style>
    /* ---- Reset & base ---- */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #1a1a2e;
      color: #e0e0f0;
      font-family: 'Segoe UI', system-ui, sans-serif;
      font-size: 14px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ---- Header ---- */
    header {
      background: #16213e;
      border-bottom: 2px solid #0f3460;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    header h1 {
      font-size: 18px;
      font-weight: 700;
      color: #e94560;
      letter-spacing: 0.5px;
    }
    header .subtitle {
      font-size: 12px;
      color: #8888aa;
    }

    /* ---- Tab nav ---- */
    nav.tabs {
      background: #16213e;
      display: flex;
      gap: 2px;
      padding: 0 20px;
      border-bottom: 1px solid #0f3460;
    }
    nav.tabs button {
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: #8888aa;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      padding: 10px 18px;
      transition: color 0.15s, border-color 0.15s;
    }
    nav.tabs button:hover { color: #c0c0e0; }
    nav.tabs button.active {
      color: #e94560;
      border-bottom-color: #e94560;
    }

    /* ---- Main content ---- */
    main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      padding-bottom: 60px;
    }

    /* ---- Tab panels ---- */
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* ---- Cards ---- */
    .card {
      background: #16213e;
      border: 1px solid #0f3460;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .card h2 {
      font-size: 14px;
      font-weight: 700;
      color: #a0a8cc;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ---- Buttons ---- */
    .btn {
      background: #0f3460;
      border: 1px solid #1a5276;
      border-radius: 4px;
      color: #c8d0f0;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      padding: 7px 14px;
      transition: background 0.15s, border-color 0.15s;
    }
    .btn:hover { background: #1a4a80; border-color: #2a6aaa; }
    .btn:active { background: #0a2040; }
    .btn.danger { background: #3d1a1a; border-color: #7a2a2a; color: #f0c0c0; }
    .btn.danger:hover { background: #5a2020; }
    .btn.small { font-size: 11px; padding: 4px 10px; }
    .btn-group { display: flex; flex-wrap: wrap; gap: 8px; }

    /* ---- Output pre ---- */
    pre.output {
      background: #0d0d1a;
      border: 1px solid #0f3460;
      border-radius: 4px;
      color: #90ee90;
      font-family: 'Consolas', 'Courier New', monospace;
      font-size: 12px;
      margin-top: 12px;
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    pre.output.hidden { display: none; }
    pre.output.error { color: #ff8080; }

    /* ---- Tables ---- */
    table {
      border-collapse: collapse;
      font-size: 13px;
      width: 100%;
    }
    th {
      background: #0f3460;
      color: #a0a8cc;
      font-weight: 600;
      padding: 8px 10px;
      text-align: left;
    }
    td {
      border-bottom: 1px solid #1a2a4a;
      color: #c8d0e8;
      padding: 7px 10px;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #1c2a4e; }

    /* ---- Badge ---- */
    .badge {
      background: #0f3460;
      border-radius: 3px;
      font-size: 11px;
      padding: 2px 6px;
    }
    .badge.run { background: #1a4020; color: #80d080; }
    .badge.shadow { background: #2a1a40; color: #c080f0; }
    .badge.sweep { background: #3a2a10; color: #f0c060; }
    .badge.batch { background: #1a3040; color: #60c0f0; }

    /* ---- Manual path input ---- */
    .input-row { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
    input[type="text"] {
      background: #0d0d1a;
      border: 1px solid #0f3460;
      border-radius: 4px;
      color: #e0e0f0;
      flex: 1;
      font-size: 13px;
      padding: 7px 10px;
    }
    input[type="text"]::placeholder { color: #444466; }
    input[type="text"]:focus { border-color: #2a5090; outline: none; }

    /* ---- Status bar ---- */
    #status-bar {
      background: #0d0d1a;
      border-top: 1px solid #0f3460;
      bottom: 0;
      color: #8888aa;
      font-size: 12px;
      left: 0;
      padding: 6px 20px;
      position: fixed;
      right: 0;
    }
    #status-bar.ok { color: #80d080; }
    #status-bar.err { color: #ff8080; }

    /* ---- Misc ---- */
    .empty-msg { color: #555577; font-style: italic; }
    .path-text { color: #8888aa; font-family: monospace; font-size: 11px; word-break: break-all; }
    .refresh-note { color: #555577; font-size: 11px; margin-top: 6px; }
  </style>
</head>
<body>

<header>
  <h1>SimTrader Studio</h1>
  <span class="subtitle">Local control panel — localhost only</span>
</header>

<nav class="tabs" id="tab-nav">
  <button class="active" data-tab="dashboard">Dashboard</button>
  <button data-tab="sessions">Sessions</button>
  <button data-tab="tapes">Tapes</button>
  <button data-tab="reports">Reports</button>
  <button data-tab="ondemand">OnDemand</button>
</nav>

<main>

  <!-- ================================================================ -->
  <!-- DASHBOARD TAB                                                      -->
  <!-- ================================================================ -->
  <div class="tab-panel active" id="tab-dashboard">

    <div class="card">
      <h2>Quick Actions</h2>
      <div class="btn-group">
        <button class="btn" onclick="runCmd('quickrun', ['--dry-run'])">quickrun --dry-run</button>
        <button class="btn" onclick="runCmd('shadow', ['--dry-run'])">shadow --dry-run</button>
        <button class="btn" onclick="runCmd('browse', [])">browse</button>
        <button class="btn danger" onclick="runCmd('clean', ['--yes'])">clean --yes</button>
      </div>
      <pre class="output hidden" id="dashboard-output"></pre>
    </div>

    <div class="card">
      <h2>Last 10 Artifacts</h2>
      <div id="recent-artifacts-container">
        <span class="empty-msg">Loading...</span>
      </div>
      <p class="refresh-note">Refreshes every 30 seconds.</p>
    </div>

  </div>

  <!-- ================================================================ -->
  <!-- SESSIONS TAB                                                       -->
  <!-- ================================================================ -->
  <div class="tab-panel" id="tab-sessions">
    <div class="card">
      <h2>Completed Runs and Shadow Sessions</h2>
      <div id="sessions-container">
        <span class="empty-msg">Loading...</span>
      </div>
    </div>
  </div>

  <!-- ================================================================ -->
  <!-- TAPES TAB                                                          -->
  <!-- ================================================================ -->
  <div class="tab-panel" id="tab-tapes">
    <div class="card">
      <h2>Recorded WS Tapes</h2>
      <div id="tapes-container">
        <span class="empty-msg">Loading...</span>
      </div>
    </div>
  </div>

  <!-- ================================================================ -->
  <!-- REPORTS TAB                                                        -->
  <!-- ================================================================ -->
  <div class="tab-panel" id="tab-reports">
    <div class="card">
      <h2>Artifacts with Reports</h2>
      <div id="reports-container">
        <span class="empty-msg">Loading...</span>
      </div>
    </div>

    <div class="card">
      <h2>Generate Report for Artifact Directory</h2>
      <p style="color:#8888aa;margin-bottom:8px;">Paste an artifact directory path (e.g. artifacts/simtrader/runs/20260226T120000Z_mymarket).</p>
      <div class="input-row">
        <input type="text" id="report-path-input" placeholder="artifacts/simtrader/runs/..." />
        <button class="btn" onclick="generateReport()">Generate Report</button>
      </div>
      <pre class="output hidden" id="report-manual-output"></pre>
    </div>
  </div>

  <!-- ================================================================ -->
  <!-- ONDEMAND TAB                                                       -->
  <!-- ================================================================ -->
  <div class="tab-panel" id="tab-ondemand">

    <!-- Session setup -->
    <div class="card">
      <h2>New OnDemand Session</h2>
      <div class="input-row" style="flex-wrap:wrap;gap:8px;margin-bottom:8px;">
        <select id="od-tape-select" style="background:#0d0d1a;border:1px solid #0f3460;border-radius:4px;color:#e0e0f0;font-size:13px;padding:7px 10px;flex:2;min-width:200px;">
          <option value="">-- select tape --</option>
        </select>
        <input type="text" id="od-starting-cash" placeholder="starting cash (e.g. 1000)" value="1000" style="flex:1;min-width:120px;" />
        <input type="text" id="od-fee-rate-bps" placeholder="fee bps (default 200)" style="flex:1;min-width:100px;" />
        <select id="od-mark-method" style="background:#0d0d1a;border:1px solid #0f3460;border-radius:4px;color:#e0e0f0;font-size:13px;padding:7px 10px;">
          <option value="bid">mark: bid</option>
          <option value="midpoint">mark: midpoint</option>
        </select>
        <button class="btn" onclick="odNewSession()">New Session</button>
      </div>
      <div id="od-session-info" style="color:#8888aa;font-size:12px;"></div>
    </div>

    <!-- Playback controls (hidden until session active) -->
    <div class="card" id="od-controls-card" style="display:none;">
      <h2>Playback</h2>
      <div class="btn-group">
        <button class="btn" onclick="odStep(1)">Step</button>
        <button class="btn" onclick="odStep(50)">Play 50</button>
        <button class="btn" onclick="odStep(200)">Play 200</button>
        <button class="btn" onclick="odSave()">Save Artifacts</button>
        <button class="btn danger" onclick="odClose()">Close Session</button>
      </div>
      <div id="od-status" style="color:#8888aa;font-size:12px;margin-top:8px;">No session.</div>
    </div>

    <!-- Market state -->
    <div class="card" id="od-market-card" style="display:none;">
      <h2>Market State</h2>
      <div id="od-bbo" style="font-family:monospace;font-size:13px;margin-bottom:8px;"></div>
      <div style="display:flex;gap:16px;">
        <div style="flex:1;">
          <div style="color:#a0a8cc;font-size:11px;font-weight:700;text-transform:uppercase;margin-bottom:4px;">Bids</div>
          <table id="od-bids-table"><thead><tr><th>Price</th><th>Size</th></tr></thead><tbody></tbody></table>
        </div>
        <div style="flex:1;">
          <div style="color:#a0a8cc;font-size:11px;font-weight:700;text-transform:uppercase;margin-bottom:4px;">Asks</div>
          <table id="od-asks-table"><thead><tr><th>Price</th><th>Size</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div id="od-ltp" style="margin-top:8px;color:#8888aa;font-size:12px;"></div>
    </div>

    <!-- Portfolio -->
    <div class="card" id="od-portfolio-card" style="display:none;">
      <h2>Portfolio</h2>
      <div id="od-portfolio" style="font-family:monospace;font-size:13px;"></div>
    </div>

    <!-- Order entry -->
    <div class="card" id="od-order-card" style="display:none;">
      <h2>Order Entry</h2>
      <div class="input-row" style="flex-wrap:wrap;gap:8px;">
        <input type="text" id="od-order-asset" placeholder="asset_id" style="flex:2;min-width:160px;" />
        <select id="od-order-side" style="background:#0d0d1a;border:1px solid #0f3460;border-radius:4px;color:#e0e0f0;font-size:13px;padding:7px 10px;">
          <option value="BUY">BUY</option>
          <option value="SELL">SELL</option>
        </select>
        <input type="text" id="od-order-price" placeholder="limit price (0-1)" style="flex:1;min-width:100px;" />
        <input type="text" id="od-order-size" placeholder="size" style="flex:1;min-width:80px;" />
        <button class="btn" onclick="odSubmitOrder()">Submit</button>
      </div>
      <div id="od-order-msg" style="color:#8888aa;font-size:12px;margin-top:6px;"></div>
    </div>

    <!-- Open orders -->
    <div class="card" id="od-openorders-card" style="display:none;">
      <h2>Open Orders</h2>
      <table id="od-orders-table">
        <thead><tr><th>Order ID</th><th>Asset</th><th>Side</th><th>Price</th><th>Size</th><th>Filled</th><th>Status</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

</main>

<div id="status-bar">Ready.</div>

<script>
// ---------------------------------------------------------------------------
// State
// ---------------------------------------------------------------------------
let artifactsCache = [];

// ---------------------------------------------------------------------------
// Utility: status bar
// ---------------------------------------------------------------------------
function setStatus(msg, cls) {
  const bar = document.getElementById('status-bar');
  bar.textContent = msg;
  bar.className = cls || '';
}

// ---------------------------------------------------------------------------
// Utility: API fetch wrapper
// ---------------------------------------------------------------------------
async function apiFetch(url, opts) {
  try {
    const resp = await fetch(url, opts);
    if (!resp.ok) {
      let errText = resp.statusText;
      try { const j = await resp.json(); errText = j.detail || JSON.stringify(j); } catch(_) {}
      throw new Error(`HTTP ${resp.status}: ${errText}`);
    }
    return resp;
  } catch (err) {
    setStatus('Error: ' + err.message, 'err');
    throw err;
  }
}

// ---------------------------------------------------------------------------
// Tab switching
// ---------------------------------------------------------------------------
document.getElementById('tab-nav').addEventListener('click', (e) => {
  const btn = e.target.closest('button[data-tab]');
  if (!btn) return;
  const tabId = btn.dataset.tab;

  document.querySelectorAll('#tab-nav button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('tab-' + tabId).classList.add('active');

  // Refresh relevant data on tab switch.
  if (tabId === 'sessions') renderSessions();
  if (tabId === 'tapes') loadTapes();
  if (tabId === 'reports') renderReports();
  if (tabId === 'ondemand') odRefreshTapes();
});

// ---------------------------------------------------------------------------
// Run a simtrader subcommand via /api/run
// ---------------------------------------------------------------------------
async function runCmd(command, args, outputElId) {
  const outEl = outputElId
    ? document.getElementById(outputElId)
    : document.getElementById('dashboard-output');

  outEl.classList.remove('hidden', 'error');
  outEl.textContent = `Running: simtrader ${command} ${args.join(' ')}\n...`;
  setStatus(`Running simtrader ${command}...`);

  try {
    const resp = await apiFetch('/api/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ command, args }),
    });
    const data = await resp.json();
    outEl.textContent = data.output || '(no output)';
    if (data.returncode !== 0) {
      outEl.classList.add('error');
      setStatus(`Command exited with code ${data.returncode}.`, 'err');
    } else {
      setStatus(`Command completed successfully.`, 'ok');
    }
  } catch (err) {
    outEl.textContent = 'Error: ' + err.message;
    outEl.classList.add('error');
  }
}

// ---------------------------------------------------------------------------
// Load artifacts from /api/artifacts
// ---------------------------------------------------------------------------
async function loadArtifacts() {
  try {
    const resp = await apiFetch('/api/artifacts');
    const data = await resp.json();
    artifactsCache = data.artifacts || [];
    setStatus(`Loaded ${artifactsCache.length} artifact(s).`, 'ok');
    return artifactsCache;
  } catch (_) {
    artifactsCache = [];
    return [];
  }
}

// ---------------------------------------------------------------------------
// Dashboard: render last 10 artifacts
// ---------------------------------------------------------------------------
function renderRecentArtifacts(artifacts) {
  const container = document.getElementById('recent-artifacts-container');
  const recent = artifacts.slice(0, 10);
  if (recent.length === 0) {
    container.innerHTML = '<span class="empty-msg">No artifacts found yet. Run quickrun or shadow to generate some.</span>';
    return;
  }

  const rows = recent.map(a => {
    const pathText = `<span class="path-text">${escHtml(a.artifact_path)}</span>`;
    const reportBadge = a.has_report
      ? `<span class="badge" style="color:#90ee90">report</span>`
      : '';
    return `<tr>
      <td><span class="badge ${escHtml(a.artifact_type)}">${escHtml(a.artifact_type)}</span></td>
      <td>${escHtml(a.artifact_id)}</td>
      <td>${escHtml(a.timestamp)}</td>
      <td>${reportBadge}</td>
      <td>${pathText}</td>
    </tr>`;
  }).join('');

  container.innerHTML = `
    <table>
      <thead><tr><th>Type</th><th>ID</th><th>Timestamp</th><th>Report</th><th>Path</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

async function refreshDashboard() {
  const artifacts = await loadArtifacts();
  renderRecentArtifacts(artifacts);
}

// ---------------------------------------------------------------------------
// Sessions tab
// ---------------------------------------------------------------------------
function renderSessions() {
  const container = document.getElementById('sessions-container');
  const sessions = artifactsCache.filter(a => a.artifact_type === 'run' || a.artifact_type === 'shadow');
  if (sessions.length === 0) {
    container.innerHTML = '<span class="empty-msg">No run or shadow sessions found.</span>';
    return;
  }

  const rows = sessions.map(a => {
    const reportCell = a.has_report
      ? `<button class="btn small" onclick="generateReport('${escAttr(a.artifact_path)}')">Re-report</button>`
      : `<button class="btn small" onclick="generateReport('${escAttr(a.artifact_path)}')">Generate</button>`;
    return `<tr>
      <td><span class="badge ${escHtml(a.artifact_type)}">${escHtml(a.artifact_type)}</span></td>
      <td>${escHtml(a.artifact_id)}</td>
      <td>${escHtml(a.timestamp)}</td>
      <td>${a.has_report ? 'yes' : 'no'}</td>
      <td>${reportCell}</td>
    </tr>`;
  }).join('');

  container.innerHTML = `
    <table>
      <thead><tr><th>Type</th><th>ID</th><th>Timestamp</th><th>Has Report</th><th>Action</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

// ---------------------------------------------------------------------------
// Tapes tab
// ---------------------------------------------------------------------------
async function loadTapes() {
  const container = document.getElementById('tapes-container');
  container.innerHTML = '<span class="empty-msg">Loading...</span>';
  try {
    const resp = await apiFetch('/api/tapes');
    const data = await resp.json();
    const tapes = data.tapes || [];
    if (tapes.length === 0) {
      container.innerHTML = '<span class="empty-msg">No tapes found. Use `simtrader record` or `quickrun` to record tapes.</span>';
      return;
    }
    const rows = tapes.map(t => {
      const copyBtn = `<button class="btn small" onclick="copyToClipboard('${escAttr(t.tape_path)}')">Copy path</button>`;
      return `<tr>
        <td>${escHtml(t.tape_id)}</td>
        <td>${escHtml(t.timestamp)}</td>
        <td>${copyBtn}</td>
        <td><span class="path-text">${escHtml(t.tape_path)}</span></td>
      </tr>`;
    }).join('');
    container.innerHTML = `
      <table>
        <thead><tr><th>Tape ID</th><th>Timestamp</th><th>Action</th><th>Path</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  } catch (_) {
    container.innerHTML = '<span class="empty-msg">Failed to load tapes.</span>';
  }
}

// ---------------------------------------------------------------------------
// Reports tab
// ---------------------------------------------------------------------------
function renderReports() {
  const container = document.getElementById('reports-container');
  const withReport = artifactsCache.filter(a => a.has_report);
  if (withReport.length === 0) {
    container.innerHTML = '<span class="empty-msg">No artifacts with reports found. Generate a report using the form below.</span>';
    return;
  }
  const rows = withReport.map(a => {
    const viewBtn = `<button class="btn small" onclick="generateReport('${escAttr(a.artifact_path)}', 'report-manual-output')">Re-generate</button>`;
    return `<tr>
      <td><span class="badge ${escHtml(a.artifact_type)}">${escHtml(a.artifact_type)}</span></td>
      <td>${escHtml(a.artifact_id)}</td>
      <td>${escHtml(a.timestamp)}</td>
      <td>${viewBtn}</td>
    </tr>`;
  }).join('');
  container.innerHTML = `
    <table>
      <thead><tr><th>Type</th><th>ID</th><th>Timestamp</th><th>Action</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

async function generateReport(pathArg, outputElId) {
  // If called from the manual input form (no arg), read the text input.
  const artifactPath = pathArg || document.getElementById('report-path-input').value.trim();
  if (!artifactPath) {
    setStatus('Please enter an artifact directory path.', 'err');
    return;
  }
  const outId = outputElId || 'report-manual-output';
  await runCmd('report', ['--path', artifactPath], outId);
}

// ---------------------------------------------------------------------------
// Clipboard helper
// ---------------------------------------------------------------------------
function copyToClipboard(text) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      setStatus('Copied to clipboard: ' + text, 'ok');
    }).catch(() => {
      setStatus('Copy failed. Path: ' + text, 'err');
    });
  } else {
    // Fallback for environments without clipboard API.
    setStatus('Path: ' + text, 'ok');
  }
}

// ---------------------------------------------------------------------------
// HTML escaping helpers
// ---------------------------------------------------------------------------
function escHtml(str) {
  if (str == null) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}
function escAttr(str) {
  if (str == null) return '';
  return String(str)
    .replace(/\\/g, '\\\\')
    .replace(/'/g, "\\'");
}

// ---------------------------------------------------------------------------
// Initialise
// ---------------------------------------------------------------------------
(async function init() {
  await refreshDashboard();
  // Auto-refresh every 30 seconds.
  setInterval(refreshDashboard, 30000);
})();

// ---------------------------------------------------------------------------
// OnDemand tab state
// ---------------------------------------------------------------------------
const od = {
  sessionId: null,
  state: null,
};

// Populate tape selector when OnDemand tab is activated.
function odRefreshTapes() {
  fetch('/api/tapes')
    .then(r => r.json())
    .then(data => {
      const sel = document.getElementById('od-tape-select');
      const prev = sel.value;
      sel.innerHTML = '<option value="">-- select tape --</option>';
      (data.tapes || []).forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.tape_path;
        opt.textContent = t.tape_id + ' (' + (t.timestamp || '').slice(0, 16) + ')';
        sel.appendChild(opt);
      });
      if (prev) sel.value = prev;
    })
    .catch(() => {});
}

function odShowCards(visible) {
  ['od-controls-card', 'od-market-card', 'od-portfolio-card', 'od-order-card', 'od-openorders-card'].forEach(id => {
    document.getElementById(id).style.display = visible ? '' : 'none';
  });
}

function odNewSession() {
  const tapePath = document.getElementById('od-tape-select').value;
  if (!tapePath) { setStatus('Select a tape first.', 'err'); return; }
  const startingCash = document.getElementById('od-starting-cash').value || '1000';
  const feeBps = document.getElementById('od-fee-rate-bps').value || '';
  const markMethod = document.getElementById('od-mark-method').value || 'bid';
  setStatus('Creating session...');
  fetch('/api/ondemand/new', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ tape_path: tapePath, starting_cash: startingCash, fee_rate_bps: feeBps || null, mark_method: markMethod }),
  })
  .then(r => r.json())
  .then(data => {
    if (data.detail) { setStatus('Error: ' + data.detail, 'err'); return; }
    od.sessionId = data.session_id;
    od.state = data.state;
    document.getElementById('od-session-info').textContent = 'Session: ' + od.sessionId;
    odShowCards(true);
    odRenderState(data.state);
    setStatus('Session created: ' + od.sessionId, 'ok');
  })
  .catch(e => setStatus('Error: ' + e, 'err'));
}

function odStep(n) {
  if (!od.sessionId) { setStatus('No active session.', 'err'); return; }
  fetch(`/api/ondemand/${od.sessionId}/step`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ n_steps: n }),
  })
  .then(r => r.json())
  .then(data => {
    if (data.detail) { setStatus('Error: ' + data.detail, 'err'); return; }
    od.state = data.state;
    odRenderState(data.state);
  })
  .catch(e => setStatus('Error: ' + e, 'err'));
}

function odSubmitOrder() {
  if (!od.sessionId) { setStatus('No active session.', 'err'); return; }
  const assetId = document.getElementById('od-order-asset').value.trim();
  const side = document.getElementById('od-order-side').value;
  const price = document.getElementById('od-order-price').value.trim();
  const size = document.getElementById('od-order-size').value.trim();
  if (!assetId || !price || !size) {
    document.getElementById('od-order-msg').textContent = 'Fill in all order fields.';
    return;
  }
  fetch(`/api/ondemand/${od.sessionId}/order`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ asset_id: assetId, side: side, limit_price: price, size: size }),
  })
  .then(r => r.json())
  .then(data => {
    if (data.detail) { document.getElementById('od-order-msg').textContent = 'Error: ' + data.detail; return; }
    document.getElementById('od-order-msg').textContent = 'Submitted: ' + data.order_id;
    od.state = data.state;
    odRenderState(data.state);
  })
  .catch(e => { document.getElementById('od-order-msg').textContent = 'Error: ' + e; });
}

function odCancelOrder(orderId) {
  if (!od.sessionId) return;
  fetch(`/api/ondemand/${od.sessionId}/cancel`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ order_id: orderId }),
  })
  .then(r => r.json())
  .then(data => {
    if (data.detail) { setStatus('Cancel error: ' + data.detail, 'err'); return; }
    od.state = data.state;
    odRenderState(data.state);
  })
  .catch(e => setStatus('Error: ' + e, 'err'));
}

function odSave() {
  if (!od.sessionId) { setStatus('No active session.', 'err'); return; }
  fetch(`/api/ondemand/${od.sessionId}/save`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: '{}',
  })
  .then(r => r.json())
  .then(data => {
    if (data.detail) { setStatus('Save error: ' + data.detail, 'err'); return; }
    setStatus('Artifacts saved to: ' + data.artifact_dir, 'ok');
  })
  .catch(e => setStatus('Error: ' + e, 'err'));
}

function odClose() {
  if (!od.sessionId) return;
  fetch(`/api/ondemand/${od.sessionId}`, { method: 'DELETE' })
    .then(() => {
      od.sessionId = null;
      od.state = null;
      document.getElementById('od-session-info').textContent = '';
      document.getElementById('od-status').textContent = 'Session closed.';
      odShowCards(false);
      setStatus('Session closed.', 'ok');
    })
    .catch(() => {});
}

function odRenderState(state) {
  if (!state) return;
  const cursor = state.cursor || 0;
  const total = state.total_events || 0;
  const pct = total > 0 ? ((cursor / total) * 100).toFixed(1) : '0.0';
  const done = state.done ? ' [DONE]' : '';
  document.getElementById('od-status').textContent =
    `seq ${state.seq ?? '-'} | cursor ${cursor} / ${total} (${pct}%)${done}`;

  // BBO
  const bboEl = document.getElementById('od-bbo');
  const bboLines = [];
  for (const [assetId, bbo] of Object.entries(state.bbo || {})) {
    const shortId = assetId.length > 15 ? assetId.slice(0, 12) + '...' : assetId;
    bboLines.push(`${shortId}  bid=${bbo.best_bid ?? '-'}  ask=${bbo.best_ask ?? '-'}`);
  }
  bboEl.textContent = bboLines.join('\n') || 'No BBO yet.';

  // Depth — show first asset only
  const depthEntries = Object.entries(state.depth || {});
  const bidsTbody = document.querySelector('#od-bids-table tbody');
  const asksTbody = document.querySelector('#od-asks-table tbody');
  bidsTbody.innerHTML = '';
  asksTbody.innerHTML = '';
  if (depthEntries.length > 0) {
    const [, depth] = depthEntries[0];
    (depth.bids || []).forEach(l => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="color:#80d080">${l.price.toFixed(4)}</td><td>${l.size.toFixed(2)}</td>`;
      bidsTbody.appendChild(tr);
    });
    (depth.asks || []).forEach(l => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="color:#f08080">${l.price.toFixed(4)}</td><td>${l.size.toFixed(2)}</td>`;
      asksTbody.appendChild(tr);
    });
  }

  // LTP
  document.getElementById('od-ltp').textContent =
    state.last_trade_price != null ? 'Last trade: ' + state.last_trade_price : '';

  // Portfolio
  const ps = state.portfolio_snapshot || {};
  document.getElementById('od-portfolio').textContent =
    `cash=${ps.final_cash ?? '-'}  equity=${ps.final_equity ?? '-'}  realized_pnl=${ps.realized_pnl ?? '-'}  unrealized_pnl=${ps.unrealized_pnl ?? '-'}  fees=${ps.total_fees ?? '-'}`;

  // Open orders
  const ordersTbody = document.querySelector('#od-orders-table tbody');
  ordersTbody.innerHTML = '';
  (state.open_orders || []).forEach(o => {
    const tr = document.createElement('tr');
    const sideColor = o.side === 'BUY' ? '#80d080' : '#f08080';
    tr.innerHTML = `
      <td style="font-family:monospace;font-size:11px">${escHtml(o.order_id)}</td>
      <td style="font-family:monospace;font-size:11px">${escHtml(o.asset_id.slice(0, 10))}...</td>
      <td style="color:${sideColor}">${escHtml(o.side)}</td>
      <td>${escHtml(o.limit_price)}</td>
      <td>${escHtml(String(o.size))}</td>
      <td>${escHtml(String(o.filled_size))}</td>
      <td>${escHtml(o.status)}</td>
      <td><button class="btn small danger" onclick="odCancelOrder('${escAttr(o.order_id)}')">Cancel</button></td>
    `;
    ordersTbody.appendChild(tr);
  });
}
</script>

</body>
</html>
