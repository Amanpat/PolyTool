---
phase: 13-add-simtrader-studio-ondemand-tab-manual
plan: "02"
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - packages/polymarket/simtrader/studio/static/index.html
  - tests/test_simtrader_ondemand.py
autonomous: true
must_haves:
  truths:
    - "A fifth tab 'OnDemand' appears in the nav bar and is clickable"
    - "User can select a tape, set starting cash, and create a new session"
    - "User can step or play-50 through the tape and see BBO/depth/portfolio update"
    - "User can submit a limit order and see it appear in open orders table"
    - "User can cancel an open order"
    - "Status bar shows cursor position and total events"
    - "7 unit tests in test_simtrader_ondemand.py all pass"
  artifacts:
    - path: "packages/polymarket/simtrader/studio/static/index.html"
      provides: "OnDemand tab UI"
      contains: "tab-ondemand"
    - path: "tests/test_simtrader_ondemand.py"
      provides: "7 unit tests for engine + API"
      exports: []
  key_links:
    - from: "index.html [New Session] button"
      to: "POST /api/ondemand/new"
      via: "fetch('/api/ondemand/new', {method:'POST', body: JSON.stringify(...)})"
      pattern: "api/ondemand/new"
    - from: "index.html [Step] button"
      to: "POST /api/ondemand/{session_id}/step"
      via: "fetch(`/api/ondemand/${od.sessionId}/step`, ...)"
      pattern: "api/ondemand.*step"
---

<objective>
Add the OnDemand tab to index.html and write 7 unit tests for the engine and API routes.

Purpose: Gives users the interactive tape-playback UI and ensures the engine behavior is verified by tests.
Output: Updated index.html with OnDemand tab. tests/test_simtrader_ondemand.py with 7 passing tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/quick/13-add-simtrader-studio-ondemand-tab-manual/13-01-SUMMARY.md
@packages/polymarket/simtrader/studio/static/index.html
@packages/polymarket/simtrader/studio/app.py
@packages/polymarket/simtrader/studio/ondemand.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OnDemand tab to index.html</name>
  <files>packages/polymarket/simtrader/studio/static/index.html</files>
  <action>
Make three changes to index.html:

**1. Add tab button** — in the `<nav class="tabs" id="tab-nav">` block, add a fifth button after "Reports":
```html
<button data-tab="ondemand">OnDemand</button>
```

**2. Add tab panel** — after the Reports tab panel (`</div>` closing `id="tab-reports"`), insert a new tab panel:

```html
  <!-- ================================================================ -->
  <!-- ONDEMAND TAB                                                       -->
  <!-- ================================================================ -->
  <div class="tab-panel" id="tab-ondemand">

    <!-- Session setup -->
    <div class="card">
      <h2>New OnDemand Session</h2>
      <div class="input-row" style="flex-wrap:wrap;gap:8px;margin-bottom:8px;">
        <select id="od-tape-select" style="background:#0d0d1a;border:1px solid #0f3460;border-radius:4px;color:#e0e0f0;font-size:13px;padding:7px 10px;flex:2;min-width:200px;">
          <option value="">-- select tape --</option>
        </select>
        <input type="text" id="od-starting-cash" placeholder="starting cash (e.g. 1000)" value="1000" style="flex:1;min-width:120px;" />
        <input type="text" id="od-fee-rate-bps" placeholder="fee bps (default 200)" style="flex:1;min-width:100px;" />
        <select id="od-mark-method" style="background:#0d0d1a;border:1px solid #0f3460;border-radius:4px;color:#e0e0f0;font-size:13px;padding:7px 10px;">
          <option value="bid">mark: bid</option>
          <option value="midpoint">mark: midpoint</option>
        </select>
        <button class="btn" onclick="odNewSession()">New Session</button>
      </div>
      <div id="od-session-info" style="color:#8888aa;font-size:12px;"></div>
    </div>

    <!-- Playback controls (hidden until session active) -->
    <div class="card" id="od-controls-card" style="display:none;">
      <h2>Playback</h2>
      <div class="btn-group">
        <button class="btn" onclick="odStep(1)">Step</button>
        <button class="btn" onclick="odStep(50)">Play 50</button>
        <button class="btn" onclick="odStep(200)">Play 200</button>
        <button class="btn" onclick="odSave()">Save Artifacts</button>
        <button class="btn danger" onclick="odClose()">Close Session</button>
      </div>
      <div id="od-status" style="color:#8888aa;font-size:12px;margin-top:8px;">No session.</div>
    </div>

    <!-- Market state -->
    <div class="card" id="od-market-card" style="display:none;">
      <h2>Market State</h2>
      <div id="od-bbo" style="font-family:monospace;font-size:13px;margin-bottom:8px;"></div>
      <div style="display:flex;gap:16px;">
        <div style="flex:1;">
          <div style="color:#a0a8cc;font-size:11px;font-weight:700;text-transform:uppercase;margin-bottom:4px;">Bids</div>
          <table id="od-bids-table"><thead><tr><th>Price</th><th>Size</th></tr></thead><tbody></tbody></table>
        </div>
        <div style="flex:1;">
          <div style="color:#a0a8cc;font-size:11px;font-weight:700;text-transform:uppercase;margin-bottom:4px;">Asks</div>
          <table id="od-asks-table"><thead><tr><th>Price</th><th>Size</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div id="od-ltp" style="margin-top:8px;color:#8888aa;font-size:12px;"></div>
    </div>

    <!-- Portfolio -->
    <div class="card" id="od-portfolio-card" style="display:none;">
      <h2>Portfolio</h2>
      <div id="od-portfolio" style="font-family:monospace;font-size:13px;"></div>
    </div>

    <!-- Order entry -->
    <div class="card" id="od-order-card" style="display:none;">
      <h2>Order Entry</h2>
      <div class="input-row" style="flex-wrap:wrap;gap:8px;">
        <input type="text" id="od-order-asset" placeholder="asset_id" style="flex:2;min-width:160px;" />
        <select id="od-order-side" style="background:#0d0d1a;border:1px solid #0f3460;border-radius:4px;color:#e0e0f0;font-size:13px;padding:7px 10px;">
          <option value="BUY">BUY</option>
          <option value="SELL">SELL</option>
        </select>
        <input type="text" id="od-order-price" placeholder="limit price (0-1)" style="flex:1;min-width:100px;" />
        <input type="text" id="od-order-size" placeholder="size" style="flex:1;min-width:80px;" />
        <button class="btn" onclick="odSubmitOrder()">Submit</button>
      </div>
      <div id="od-order-msg" style="color:#8888aa;font-size:12px;margin-top:6px;"></div>
    </div>

    <!-- Open orders -->
    <div class="card" id="od-openorders-card" style="display:none;">
      <h2>Open Orders</h2>
      <table id="od-orders-table">
        <thead><tr><th>Order ID</th><th>Asset</th><th>Side</th><th>Price</th><th>Size</th><th>Filled</th><th>Status</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

  </div>
```

**3. Add JavaScript** — inside the `<script>` block, append the following OnDemand JS section before the closing `</script>` tag:

```javascript
// ---------------------------------------------------------------------------
// OnDemand tab state
// ---------------------------------------------------------------------------
const od = {
  sessionId: null,
  state: null,
};

// Populate tape selector when OnDemand tab is activated
function odRefreshTapes() {
  fetch('/api/tapes')
    .then(r => r.json())
    .then(data => {
      const sel = document.getElementById('od-tape-select');
      const prev = sel.value;
      sel.innerHTML = '<option value="">-- select tape --</option>';
      (data.tapes || []).forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.tape_path;
        opt.textContent = t.tape_id + ' (' + (t.timestamp || '').slice(0, 16) + ')';
        sel.appendChild(opt);
      });
      if (prev) sel.value = prev;
    })
    .catch(() => {});
}

function odShowCards(visible) {
  ['od-controls-card','od-market-card','od-portfolio-card','od-order-card','od-openorders-card'].forEach(id => {
    document.getElementById(id).style.display = visible ? '' : 'none';
  });
}

function odNewSession() {
  const tapePath = document.getElementById('od-tape-select').value;
  if (!tapePath) { setStatus('Select a tape first.', true); return; }
  const startingCash = document.getElementById('od-starting-cash').value || '1000';
  const feeBps = document.getElementById('od-fee-rate-bps').value || '';
  const markMethod = document.getElementById('od-mark-method').value || 'bid';
  setStatus('Creating session...');
  fetch('/api/ondemand/new', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({tape_path: tapePath, starting_cash: startingCash, fee_rate_bps: feeBps || null, mark_method: markMethod}),
  })
  .then(r => r.json())
  .then(data => {
    if (data.detail) { setStatus('Error: ' + data.detail, true); return; }
    od.sessionId = data.session_id;
    od.state = data.state;
    document.getElementById('od-session-info').textContent = 'Session: ' + od.sessionId;
    odShowCards(true);
    odRenderState(data.state);
    setStatus('Session created: ' + od.sessionId);
  })
  .catch(e => setStatus('Error: ' + e, true));
}

function odStep(n) {
  if (!od.sessionId) { setStatus('No active session.', true); return; }
  fetch(`/api/ondemand/${od.sessionId}/step`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({n_steps: n}),
  })
  .then(r => r.json())
  .then(data => {
    if (data.detail) { setStatus('Error: ' + data.detail, true); return; }
    od.state = data.state;
    odRenderState(data.state);
  })
  .catch(e => setStatus('Error: ' + e, true));
}

function odSubmitOrder() {
  if (!od.sessionId) { setStatus('No active session.', true); return; }
  const assetId = document.getElementById('od-order-asset').value.trim();
  const side = document.getElementById('od-order-side').value;
  const price = document.getElementById('od-order-price').value.trim();
  const size = document.getElementById('od-order-size').value.trim();
  if (!assetId || !price || !size) {
    document.getElementById('od-order-msg').textContent = 'Fill in all order fields.';
    return;
  }
  fetch(`/api/ondemand/${od.sessionId}/order`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({asset_id: assetId, side, limit_price: price, size}),
  })
  .then(r => r.json())
  .then(data => {
    if (data.detail) { document.getElementById('od-order-msg').textContent = 'Error: ' + data.detail; return; }
    document.getElementById('od-order-msg').textContent = 'Submitted: ' + data.order_id;
    od.state = data.state;
    odRenderState(data.state);
  })
  .catch(e => { document.getElementById('od-order-msg').textContent = 'Error: ' + e; });
}

function odCancelOrder(orderId) {
  if (!od.sessionId) return;
  fetch(`/api/ondemand/${od.sessionId}/cancel`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({order_id: orderId}),
  })
  .then(r => r.json())
  .then(data => {
    if (data.detail) { setStatus('Cancel error: ' + data.detail, true); return; }
    od.state = data.state;
    odRenderState(data.state);
  })
  .catch(e => setStatus('Error: ' + e, true));
}

function odSave() {
  if (!od.sessionId) { setStatus('No active session.', true); return; }
  fetch(`/api/ondemand/${od.sessionId}/save`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: '{}'})
  .then(r => r.json())
  .then(data => {
    if (data.detail) { setStatus('Save error: ' + data.detail, true); return; }
    setStatus('Artifacts saved to: ' + data.artifact_dir);
  })
  .catch(e => setStatus('Error: ' + e, true));
}

function odClose() {
  if (!od.sessionId) return;
  fetch(`/api/ondemand/${od.sessionId}`, {method: 'DELETE'})
    .then(() => {
      od.sessionId = null;
      od.state = null;
      document.getElementById('od-session-info').textContent = '';
      document.getElementById('od-status').textContent = 'Session closed.';
      odShowCards(false);
      setStatus('Session closed.');
    })
    .catch(() => {});
}

function odRenderState(state) {
  if (!state) return;
  const cursor = state.cursor || 0;
  const total = state.total_events || 0;
  const pct = total > 0 ? ((cursor / total) * 100).toFixed(1) : '0.0';
  const done = state.done ? ' [DONE]' : '';
  document.getElementById('od-status').textContent =
    `seq ${state.seq ?? '-'} | cursor ${cursor} / ${total} (${pct}%)${done}`;

  // BBO
  const bboEl = document.getElementById('od-bbo');
  const bboLines = [];
  for (const [assetId, bbo] of Object.entries(state.bbo || {})) {
    const shortId = assetId.slice(0, 12) + '...';
    bboLines.push(`${shortId}  bid=${bbo.best_bid ?? '-'}  ask=${bbo.best_ask ?? '-'}`);
  }
  bboEl.textContent = bboLines.join('\n') || 'No BBO yet.';

  // Depth — show first asset only
  const depthEntries = Object.entries(state.depth || {});
  const bidsTbody = document.querySelector('#od-bids-table tbody');
  const asksTbody = document.querySelector('#od-asks-table tbody');
  bidsTbody.innerHTML = '';
  asksTbody.innerHTML = '';
  if (depthEntries.length > 0) {
    const [, depth] = depthEntries[0];
    (depth.bids || []).forEach(l => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="color:#80d080">${l.price.toFixed(4)}</td><td>${l.size.toFixed(2)}</td>`;
      bidsTbody.appendChild(tr);
    });
    (depth.asks || []).forEach(l => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="color:#f08080">${l.price.toFixed(4)}</td><td>${l.size.toFixed(2)}</td>`;
      asksTbody.appendChild(tr);
    });
  }

  // LTP
  document.getElementById('od-ltp').textContent =
    state.last_trade_price != null ? 'Last trade: ' + state.last_trade_price : '';

  // Portfolio
  const ps = state.portfolio_snapshot || {};
  document.getElementById('od-portfolio').textContent =
    `cash=${ps.final_cash ?? '-'}  equity=${ps.final_equity ?? '-'}  realized_pnl=${ps.realized_pnl ?? '-'}  unrealized_pnl=${ps.unrealized_pnl ?? '-'}  fees=${ps.total_fees ?? '-'}`;

  // Open orders
  const ordersTbody = document.querySelector('#od-orders-table tbody');
  ordersTbody.innerHTML = '';
  (state.open_orders || []).forEach(o => {
    const tr = document.createElement('tr');
    const sideColor = o.side === 'BUY' ? '#80d080' : '#f08080';
    tr.innerHTML = `
      <td style="font-family:monospace;font-size:11px">${o.order_id}</td>
      <td style="font-family:monospace;font-size:11px">${o.asset_id.slice(0,10)}...</td>
      <td style="color:${sideColor}">${o.side}</td>
      <td>${o.limit_price}</td>
      <td>${o.size}</td>
      <td>${o.filled_size}</td>
      <td>${o.status}</td>
      <td><button class="btn small danger" onclick="odCancelOrder('${o.order_id}')">Cancel</button></td>
    `;
    ordersTbody.appendChild(tr);
  });
}

// Hook into tab switch to refresh tapes
const _origShowTab = showTab;  // will be defined; see existing switchTab logic
```

Note: The existing JavaScript uses a `showTab(tabName)` or similar function that switches `.active` classes. Find the existing tab-switch code in the script block and add a call to `odRefreshTapes()` when `tabName === 'ondemand'`:

Locate the existing tab click handler (it uses `data-tab` attribute and sets `.active` classes). Inside it, after switching the active tab, add:
```javascript
if (tabName === 'ondemand') odRefreshTapes();
```

Read the existing script carefully to find the exact location. The JS tab handler is typically in the `DOMContentLoaded` listener or as a direct handler on the nav buttons.
  </action>
  <verify>
python -c "
content = open('packages/polymarket/simtrader/studio/static/index.html', encoding='utf-8').read()
assert 'tab-ondemand' in content, 'Missing tab-ondemand panel'
assert 'OnDemand' in content, 'Missing OnDemand tab button'
assert 'odNewSession' in content, 'Missing odNewSession JS'
assert 'odStep' in content, 'Missing odStep JS'
assert 'api/ondemand/new' in content, 'Missing API call'
print('index.html OnDemand tab OK')
"
  </verify>
  <done>index.html has a fifth "OnDemand" tab button in the nav, a corresponding tab-panel with all UI sections (session setup, playback controls, market state, portfolio, order entry, open orders table), and JavaScript that wires all 8 API endpoints.</done>
</task>

<task type="auto">
  <name>Task 2: Write 7 unit tests for OnDemand engine and API</name>
  <files>tests/test_simtrader_ondemand.py</files>
  <action>
Create `tests/test_simtrader_ondemand.py` with 7 tests. Use pytest. All tests use synthetic data (no real tape files), passing events directly via a helper or tmpdir fixture.

**Test setup helper:**

```python
import json
import pathlib
import pytest
from decimal import Decimal
from fastapi.testclient import TestClient

def _write_tape(tmp_path: pathlib.Path, events: list[dict]) -> pathlib.Path:
    """Write events.jsonl to a tape directory and return the tape dir path."""
    tape_dir = tmp_path / "tape_01"
    tape_dir.mkdir()
    (tape_dir / "events.jsonl").write_text(
        "\n".join(json.dumps(e) for e in events) + "\n",
        encoding="utf-8",
    )
    return tape_dir

def _book_events(asset_id: str = "tok1") -> list[dict]:
    """Return a minimal synthetic tape: book snapshot + 3 price_changes."""
    return [
        {"event_type": "book", "seq": 1, "ts_recv": 1000.0, "asset_id": asset_id,
         "bids": [{"price": "0.52", "size": "100"}, {"price": "0.51", "size": "200"}],
         "asks": [{"price": "0.53", "size": "150"}, {"price": "0.54", "size": "50"}]},
        {"event_type": "price_change", "seq": 2, "ts_recv": 1001.0, "asset_id": asset_id,
         "changes": [{"side": "BUY", "price": "0.52", "size": "120"}]},
        {"event_type": "price_change", "seq": 3, "ts_recv": 1002.0, "asset_id": asset_id,
         "changes": [{"side": "SELL", "price": "0.53", "size": "160"}]},
        {"event_type": "last_trade_price", "seq": 4, "ts_recv": 1003.0, "asset_id": asset_id,
         "price": 0.525},
    ]
```

**Test 1: test_l2book_top_bids_asks**
```python
def test_l2book_top_bids_asks():
    from packages.polymarket.simtrader.orderbook.l2book import L2Book
    b = L2Book("tok", strict=False)
    b.apply({"event_type": "book", "bids": [
        {"price": "0.50", "size": "100"},
        {"price": "0.52", "size": "80"},
        {"price": "0.51", "size": "60"},
    ], "asks": [
        {"price": "0.53", "size": "40"},
        {"price": "0.55", "size": "20"},
    ]})
    bids = b.top_bids(2)
    assert len(bids) == 2
    assert bids[0]["price"] == pytest.approx(0.52)  # highest first
    assert bids[1]["price"] == pytest.approx(0.51)
    asks = b.top_asks(2)
    assert len(asks) == 2
    assert asks[0]["price"] == pytest.approx(0.53)  # lowest first
    assert asks[1]["price"] == pytest.approx(0.55)
    # n > available levels
    assert len(b.top_bids(10)) == 3
```

**Test 2: test_ondemand_engine_step**
```python
def test_ondemand_engine_step(tmp_path):
    from packages.polymarket.simtrader.studio.ondemand import OnDemandSession
    tape_dir = _write_tape(tmp_path, _book_events())
    sess = OnDemandSession(str(tape_dir), Decimal("1000"))
    assert sess._cursor == 0
    state = sess.step(1)
    assert state["cursor"] == 1
    assert state["done"] is False
    # After book snapshot, bbo should be populated for tok1
    assert "tok1" in state["bbo"]
    assert state["bbo"]["tok1"]["best_bid"] == pytest.approx(0.52)
    assert state["bbo"]["tok1"]["best_ask"] == pytest.approx(0.53)
    # depth populated
    assert len(state["depth"]["tok1"]["bids"]) > 0
```

**Test 3: test_ondemand_engine_order_and_fill**
```python
def test_ondemand_engine_order_and_fill(tmp_path):
    from packages.polymarket.simtrader.studio.ondemand import OnDemandSession
    # Build tape with book snapshot then a price_change that should trigger fill
    events = [
        {"event_type": "book", "seq": 1, "ts_recv": 1000.0, "asset_id": "tok1",
         "bids": [{"price": "0.50", "size": "100"}],
         "asks": [{"price": "0.55", "size": "100"}]},
        {"event_type": "price_change", "seq": 2, "ts_recv": 1001.0, "asset_id": "tok1",
         "changes": [{"side": "SELL", "price": "0.51", "size": "50"}]},
    ]
    tape_dir = _write_tape(tmp_path, events)
    sess = OnDemandSession(str(tape_dir), Decimal("1000"))
    sess.step(1)  # apply book snapshot
    order_id, state = sess.submit_order("tok1", "BUY", Decimal("0.55"), Decimal("10"))
    assert order_id is not None
    # order should appear in open orders
    assert any(o["order_id"] == order_id for o in state["open_orders"])
    # step forward — fill may occur against ask side
    state2 = sess.step(1)
    # user_actions recorded
    assert len(sess._user_actions) == 1
    assert sess._user_actions[0]["action"] == "submit_order"
```

**Test 4: test_ondemand_save_artifacts**
```python
def test_ondemand_save_artifacts(tmp_path):
    from packages.polymarket.simtrader.studio.ondemand import OnDemandSession
    tape_dir = _write_tape(tmp_path, _book_events())
    sess = OnDemandSession(str(tape_dir), Decimal("500"))
    sess.step(4)  # consume all events
    save_dir = tmp_path / "session_out"
    sess.save_artifacts(save_dir)
    expected = {"user_actions.jsonl", "orders.jsonl", "fills.jsonl",
                "ledger.jsonl", "equity_curve.jsonl", "run_manifest.json"}
    written = {f.name for f in save_dir.iterdir()}
    assert expected == written, f"Missing files: {expected - written}"
    # run_manifest has required keys
    manifest = json.loads((save_dir / "run_manifest.json").read_text())
    assert "session_id" in manifest
    assert "tape_path" in manifest
    assert "summary" in manifest
```

**Test 5: test_api_new_session**
```python
def test_api_new_session(tmp_path):
    from packages.polymarket.simtrader.studio.app import create_app
    tape_dir = _write_tape(tmp_path, _book_events())
    app = create_app(tmp_path)
    client = TestClient(app)
    resp = client.post("/api/ondemand/new", json={
        "tape_path": str(tape_dir),
        "starting_cash": "1000",
        "fee_rate_bps": None,
        "mark_method": "bid",
    })
    assert resp.status_code == 200
    data = resp.json()
    assert "session_id" in data
    assert "state" in data
    assert data["state"]["cursor"] == 0
```

**Test 6: test_api_step**
```python
def test_api_step(tmp_path):
    from packages.polymarket.simtrader.studio.app import create_app
    tape_dir = _write_tape(tmp_path, _book_events())
    app = create_app(tmp_path)
    client = TestClient(app)
    new_resp = client.post("/api/ondemand/new", json={
        "tape_path": str(tape_dir), "starting_cash": "1000",
    })
    session_id = new_resp.json()["session_id"]
    step_resp = client.post(f"/api/ondemand/{session_id}/step", json={"n_steps": 2})
    assert step_resp.status_code == 200
    state = step_resp.json()["state"]
    assert state["cursor"] == 2
    assert state["seq"] is not None
```

**Test 7: test_api_order**
```python
def test_api_order(tmp_path):
    from packages.polymarket.simtrader.studio.app import create_app
    tape_dir = _write_tape(tmp_path, _book_events())
    app = create_app(tmp_path)
    client = TestClient(app)
    new_resp = client.post("/api/ondemand/new", json={
        "tape_path": str(tape_dir), "starting_cash": "1000",
    })
    session_id = new_resp.json()["session_id"]
    # Step to get a seq
    client.post(f"/api/ondemand/{session_id}/step", json={"n_steps": 1})
    order_resp = client.post(f"/api/ondemand/{session_id}/order", json={
        "asset_id": "tok1",
        "side": "BUY",
        "limit_price": "0.53",
        "size": "10",
    })
    assert order_resp.status_code == 200
    data = order_resp.json()
    assert "order_id" in data
    assert len(data["order_id"]) > 0
    # order appears in open_orders
    assert any(o["order_id"] == data["order_id"] for o in data["state"]["open_orders"])
```

Run all 7 tests with:
```
python -m pytest tests/test_simtrader_ondemand.py -v --tb=short
```
  </action>
  <verify>
python -m pytest tests/test_simtrader_ondemand.py -v --tb=short
  </verify>
  <done>All 7 tests in test_simtrader_ondemand.py pass. No existing tests broken (run pytest --tb=short -q to confirm total count increased by 7).</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `python -m pytest tests/test_simtrader_ondemand.py -v --tb=short` — all 7 new tests pass.
2. `python -m pytest tests/ -q --tb=short -x` — full suite passes (no regressions).
3. HTML check: `grep -c "OnDemand" packages/polymarket/simtrader/studio/static/index.html` returns >= 2 (tab button + section heading).
4. API fetch check: `grep "api/ondemand" packages/polymarket/simtrader/studio/static/index.html | wc -l` returns >= 5.
</verification>

<success_criteria>
- "OnDemand" tab appears in the Studio nav bar
- All session setup, playback, order entry, and open orders UI sections render correctly
- JavaScript wires all 8 /api/ondemand/* endpoints
- 7 unit tests pass covering: L2Book depth, engine step, order+fill, save artifacts, API new/step/order
- Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/quick/13-add-simtrader-studio-ondemand-tab-manual/13-02-SUMMARY.md`
</output>
